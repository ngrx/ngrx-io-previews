2c2fc556 use setState in patchState; remove isInitialized check; improve test case with callback
